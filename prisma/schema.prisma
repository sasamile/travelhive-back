// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
}

enum TripStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ExpeditionStatus {
  AVAILABLE
  FULL
  CANCELLED
  COMPLETED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum BookingItemType {
  ADULT
  CHILD
  EXTRA
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum AgencyApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// Tabla de Better Auth - User (para autenticación)
model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false) @map("email_verified")
  image         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Campos adicionales personalizados
  dniUser     String? @map("dni_user")
  phoneUser   String? @map("phone_user")

  // Relaciones
  sessions          Session[]
  accounts          Account[]
  agencyMembers     AgencyMember[]
  bookings          Booking[]           @relation("OwnerBuy")
  discountCodeUsage DiscountCodeUsage[]

  @@map("user")
}

// Tabla de Better Auth - Session
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

// Tabla de Better Auth - Account
model Account {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  idToken               String?   @map("id_token")
  password              String? // Para email/password authentication
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

// Tabla de Better Auth - Verification
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verification")
}

// Ciudades
model City {
  idCity   BigInt @id @default(autoincrement()) @map("id_city")
  nameCity String @map("name_city")

  trips Trip[]

  @@map("cities")
}

// Agencias
model Agency {
  idAgency        BigInt               @id @default(autoincrement()) @map("id_agency")
  nameAgency      String               @map("name_agency")
  email           String?
  phone           String?
  agencyId        String?              @unique @map("agency_id")
  nit             String?              @unique // Número de Identificación Tributaria
  rntNumber       String?              @unique @map("rnt_number") // Registro Nacional de Turismo
  picture         String?
  status          String               @default("active")
  approvalStatus  AgencyApprovalStatus @default(PENDING) @map("approval_status") // Estado de aprobación por superadmin
  rejectionReason String?              @map("rejection_reason") // Razón de rechazo si es rechazada
  reviewedBy      String?              @map("reviewed_by") // ID del superadmin que revisó
  reviewedAt      DateTime?            @map("reviewed_at") // Fecha de revisión
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  agencyMembers AgencyMember[]
  trips         Trip[]
  bookings      Booking[]
  discountCodes DiscountCode[]

  @@map("agencies")
}

// Miembros de agencias (relación muchos a muchos con roles)
model AgencyMember {
  id        BigInt   @id @default(autoincrement())
  idAgency  BigInt   @map("id_agency")
  idUser    String   @map("user_id") // Cambiado a String para Better Auth
  role      String // 'admin', 'editor', 'agent', etc.
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  agency Agency @relation(fields: [idAgency], references: [idAgency], onDelete: Cascade)
  user   User   @relation(fields: [idUser], references: [id], onDelete: Cascade)

  @@unique([idAgency, idUser])
  @@map("agency_members")
}

// Viajes
model Trip {
  idTrip         BigInt     @id @default(autoincrement()) @map("id_trip")
  idAgency       BigInt     @map("id_agency")
  idCity         BigInt     @map("id_city")
  title          String
  description    String?
  category       String
  vibe           String?
  durationDays   Int        @map("duration_days")
  durationNights Int        @map("duration_nights")
  coverImage     String?    @map("cover_image")
  status         TripStatus @default(DRAFT)
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  agency        Agency         @relation(fields: [idAgency], references: [idAgency], onDelete: Cascade)
  city          City           @relation(fields: [idCity], references: [idCity], onDelete: Restrict)
  expeditions   Expedition[]
  bookings      Booking[]
  discountCodes DiscountCode[]

  @@map("trips")
}

// Expediciones (instancias de viajes con fechas)
model Expedition {
  idExpedition      BigInt           @id @default(autoincrement()) @map("id_expedition")
  idTrip            BigInt           @map("id_trip")
  startDate         DateTime         @map("start_date")
  endDate           DateTime         @map("end_date")
  capacityTotal     Int              @map("capacity_total")
  capacityAvailable Int              @map("capacity_available")
  priceAdult        Decimal          @map("price_adult")
  priceChild        Decimal?         @map("price_child")
  currency          String           @default("USD")
  status            ExpeditionStatus @default(AVAILABLE)
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  trip          Trip           @relation(fields: [idTrip], references: [idTrip], onDelete: Cascade)
  bookings      Booking[]
  discountCodes DiscountCode[]

  @@map("expeditions")
}

// Reservas
model Booking {
  idBooking      BigInt        @id @default(autoincrement()) @map("id_booking")
  idExpedition   BigInt        @map("id_expedition")
  idTrip         BigInt        @map("id_trip")
  idAgency       BigInt        @map("id_agency")
  ownerBuy       String        @map("owner_buy") // Cambiado a String para Better Auth
  dateBuy        DateTime      @default(now()) @map("date_buy")
  referenceBuy   String?       @map("reference_buy")
  status         BookingStatus @default(PENDING)
  subtotal       Decimal       @map("subtotal")
  serviceFee     Decimal       @default(0) @map("service_fee")
  discountCode   String?       @map("discount_code")
  discountAmount Decimal       @default(0) @map("discount_amount")
  totalBuy       Decimal       @map("total_buy")
  currency       String        @default("USD")
  transactionId  String?       @map("transaction_id")
  paymentSource  String?       @map("payment_source")
  ticketsPdfKey  String?       @map("tickets_pdf_key")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  expedition        Expedition          @relation(fields: [idExpedition], references: [idExpedition], onDelete: Restrict)
  trip              Trip                @relation(fields: [idTrip], references: [idTrip], onDelete: Restrict)
  agency            Agency              @relation(fields: [idAgency], references: [idAgency], onDelete: Restrict)
  owner             User                @relation("OwnerBuy", fields: [ownerBuy], references: [id], onDelete: Restrict)
  bookingItems      BookingItem[]
  discountCodeUsage DiscountCodeUsage[]

  @@map("bookings")
}

// Ítems de reserva
model BookingItem {
  id          BigInt          @id @default(autoincrement())
  idBooking   BigInt          @map("id_booking")
  itemType    BookingItemType @map("item_type")
  description String?
  quantity    Int
  unitPrice   Decimal         @map("unit_price")
  totalPrice  Decimal         @map("total_price")
  createdAt   DateTime        @default(now()) @map("created_at")

  booking Booking @relation(fields: [idBooking], references: [idBooking], onDelete: Cascade)

  @@map("booking_items")
}

// Códigos de descuento
model DiscountCode {
  id           BigInt       @id @default(autoincrement())
  codeName     String       @unique @map("code_name")
  discountType DiscountType @map("discount_type")
  value        Decimal
  maxUses      Int?         @map("max_uses")
  perUserLimit Int?         @map("per_user_limit")
  usedCount    Int          @default(0) @map("used_count")
  active       Boolean      @default(true)
  idAgency     BigInt?      @map("id_agency")
  idTrip       BigInt?      @map("id_trip")
  idExpedition BigInt?      @map("id_expedition")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  agency            Agency?             @relation(fields: [idAgency], references: [idAgency], onDelete: Cascade)
  trip              Trip?               @relation(fields: [idTrip], references: [idTrip], onDelete: Cascade)
  expedition        Expedition?         @relation(fields: [idExpedition], references: [idExpedition], onDelete: Cascade)
  discountCodeUsage DiscountCodeUsage[]

  @@map("discount_codes")
}

// Uso de códigos de descuento
model DiscountCodeUsage {
  id             BigInt   @id @default(autoincrement())
  discountCodeId BigInt   @map("discount_code_id")
  userId         String   @map("user_id") // Cambiado a String para Better Auth
  bookingId      BigInt   @map("booking_id")
  usedAt         DateTime @default(now()) @map("used_at")

  discountCode DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking      Booking      @relation(fields: [bookingId], references: [idBooking], onDelete: Cascade)

  @@map("discount_code_usage")
}
